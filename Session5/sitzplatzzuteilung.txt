Welche Kandidaten haben in einem Stimmkreis per Erststimme gewonnen? 
WITH STIMMKREISGEWINNER_HELP AS (
    SELECT STIMMKREISNR, MAX(ANZAHLERSTSTIMMEN) AS MAXSTIMMEN
    FROM AGGREGATKANDIDATERSTSTIMMEN
    WHERE JAHR = 2018
    GROUP BY STIMMKREISNR),
STIMMKREISGEWINNER AS (
    SELECT A.STIMMKREISNR AS STIMMKREIS, A.KANDIDATNR AS GEWINNER
    FROM AGGREGATKANDIDATERSTSTIMMEN A JOIN STIMMKREISGEWINNER_HELP S    ON ((A.STIMMKREISNR = S.STIMMKREISNR) AND (S.MAXSTIMMEN = A.ANZAHLERSTSTIMMEN))
    WHERE JAHR = 2018),
2. Wie viele Stimmen (Erststimmen + Zweitstimmen) gab es insgesamt pro Wahlkreis? Wie viele Stimmen hatte jede Partei in jedem Wahlkreis? Wie viele Sitze hat ein Wahlkreis? Wie viele Mandate erhält jede Partei pro Wahlkreis?
WAHLKREISSTIMMEN_HELP AS (
    SELECT W.NR AS WAHLKREIS, W.SITZZAHL AS SITZZAHL, S.NR AS STIMMKREIS, AK.KANDIDATNR AS KANDIDAT, AK.ANZAHLERSTSTIMMEN AS ERSTSTIMMEN, K.PARTEI AS PARTEI, AP.ANZAHLGESAMTZWEITSTIMMEN AS ZWEITSTIMMEN
    FROM (((WAHLKREIS W JOIN STIMMKREIS S ON ((W.JAHR = S.JAHR) AND (W.NR = S.WAHLKREISNR))) JOIN AGGREGATKANDIDATERSTSTIMMEN AK ON ((AK.JAHR = S.JAHR) AND (AK.STIMMKREISNR = S.NR))) JOIN KANDIDAT K ON (K.ID = AK.KANDIDATNR)) JOIN AGGREGATPARTEISTIMMEN AP ON ((AP.JAHR = S.JAHR) AND (AP.STIMMKREISNR = S.NR) AND (AP.PARTEIID = K.PARTEI))
    WHERE JAHR = 2018),
WAHLKREISGESAMTSTIMMEN AS (
    SELECT WAHLKREIS, (SUM(ZWEITSTIMMEN) + SUM(ERSTSTIMMEN)) AS GESAMTSTIMMEN
    FROM  WAHLKREISGESAMTSTIMMEN_HELP
    GROUP_BY WAHLKREIS),
WAHLKREISPARTEIGESAMTSTIMMEN AS (
    SELECT WAHLKREIS, PARTEI, (SUM(ZWEITSTIMMEN)+SUM(ERSTSTIMMEN)) AS PARTEIGESAMTSTIMMEN
    FROM WAHLKREISGESAMTSTIMMEN_HELP
    GROUP_BY WAHLKREIS, PARTEI),
SPERRKLAUSELUNTERSCHREITER AS (
	SELECT P.WAHLKREIS AS WAHLKREIS, P.PARTEI AS PARTEI, P.PARTEIGESAMTSTIMMEN AS PARTEIGESAMTSTIMMEN
	FROM WAHLKREISGESAMTSTIMMEN W JOIN WAHLKREISPARTEIGESAMTSTIMMEN P ON W.WAHLKREIS=P.WAHLKREIS
	WHERE CAST (P.PARTEIGESAMTSTIMMEN AS DECIMAL(8,2))/W.GESAMTSTIMMEN < 0.05),
WAHLKREISGESAMTSTIMMEN_NACH_KLAUSEL AS (
	SELECT W.WAHLKREIS AS WAHLKREIS, (W.GESAMTSTIMMEN - SUM(S.PARTEIGESAMTSTIMMEN)) AS GESAMTSTIMMEN
	FROM WAHLKREISGESAMTSTIMMEN W JOIN SPERRKLAUSELUNTERSCHREITER S ON W.WAHLKREIS=S.WAHLKREIS
	GROUP BY W.WAHLKREIS, W.GESAMTSTIMMEN),
WAHLKREISPARTEIGESAMTSTIMMEN_NACH_KLAUSEL AS (
	(SELECT W.*
	FROM WAHLPREISPARTEIGESAMTSTIMMEN W MINUS SPERRKLAUSELUNTERSCHREITER S)
		UNION ALL
	(SELECT WAHLKREIS, PARTEI, 0 AS PARTEIGESAMTSTIMMEN
	FROM SPERRKLAUSELUNTERSCHREITER)),
WAHLKREISSITZE AS (
    SELECT WAHLKREIS, SITZZAHL
    FROM WAHLKREISSTIMMEN_HELP),
WAHLKREISPARTEIMANDATE AS (
    SELECT WP.WAHLKREIS, WP.PARTEI, ((WP.PARTEIGESAMTSTIMMEN*WS.SITZZAHL)/(W.GESAMTSTIMMEN)) AS MANDATE
    FROM (WAHLKREISGESAMTSTIMMEN_NACH_KLAUSEL W JOIN WAHLKREISPARTEIGESAMTSTIMMEN_NACH_KLAUSEL WP ON (W.WAHLKREIS = WP.WAHLKREIS)) JOIN WAHLKREISSITZE WS ON (WS.WAHLKREIS = W.WAHLKREIS)),
3. Wie viele Gewinner aus Erststimmen hat jede Partei in jedem Wahlkreis?
WAHLKREISERSTSTIMMENGEWINNERZAHL AS (
    SELECT W.NR, K.PARTEI, COUNT(*) AS ERSTSTIMMENGEWINNERZAHL
    FROM ((WAHLKREIS W JOIN STIMMKREIS S ON ((W.NR = S.WAHLKREISNR) AND (W.JAHR = S.JAHR))) JOIN STIMMKREISGEWINNER G ON (G.STIMMKREIS=S.NR)) JOIN KANDIDATEN K ON (K.ID = G.Gewinner)
    WHERE S.JAHR = 2018
    GROUP BY W.NR, K.PARTEI),
4. Wie viele Gewinner aus Zweitstimmen hat jede Partei in jedem Wahlkreis?
WAHLKREISZWEITSTIMMENGEWINNERZAHL AS (
    SELECT M.WAHLKREIS, M.PARTEI, (M.MANDATE - G.ERSTSTIMMENGEWINNERZAHL)   AS ZWEITSTIMMENGEWINNERZAHL
    FROM WAHLKREISPARTEIMANDATE M JOIN WAHLKREISERSTSTIMMENGEWINNERZAHL G ON ((M.WAHLKREIS = G.WAHLKREIS) AND (M.PARTEI = G.PARTEI)), 
5. Wie viele Gesamtstimmen (Zweitstimmen + ggf. Erststimmen) hatte jeder Kandidat in jedem Wahlkreis? Herausgefiltert werden die Erststimmengewinner.
WAHLKREISKANDIDATGESAMTSTIMMEN AS (
    SELECT W.NR AS WAHLKREIS, K.PARTEI AS PARTEI, K.ID AS KANDIDAT, (AZ.ANZAHLZWEITSTIMMEN + COALESCE(AE.ANZAHLERSTSTIMMEN, 0)) AS KANDIDATENGESAMTSTIMMEN
    FROM (((WAHLKREIS W JOIN STIMMKREIS S ON ((W.JAHR = S.JAHR) AND (W.NR = S.WAHLKREISNR))) JOIN AGGREGATKANDIDATZWEITSTIMMEN AZ ON ((AZ.STIMMKREISNR = S.NR) AND (S.JAHR = AZ.JAHR))) JOIN KANDIDAT K ON (K.ID = AZ.KANDIDATNR)) LEFT OUTER JOIN AGGREGATKANDIDATERSTSTIMMEN AE ON ((AE.JAHR = S.JAHR) AND (S.NR = AE.STIMMKREISNR) AND (AK.KANDIDATNR = AE.KANDIDATNR))
    WHERE (JAHR = 2018) AND (K.ID NOT IN (SELECT GEWINNER FROM STIMMKREISGEWINNER))),
6. An welcher Position steht jeder Kandidat pro Partei und pro Wahlkreis? 
WAHLKREISKANDIDATPOSITIONEN AS(
    SELECT WAHLKREIS, PARTEI, KANDIDAT, ROW_NUMBER() OVER (PARTITON BY WAHLKREIS + PARTEI ORDER BY KANDIDATGESAMTSTIMMEN) AS POSITION
    FROM WAHLKREISKANDIDATGESAMTSTIMMEN),
7. Welche Kandidaten ziehen gemäß Zweitstimme in den Landtag ein?
ZWEITSTIMMENGEWINNER AS (
    SELECT P.WAHLKREIS, P.PARTEI, P.KANDIDAT
    FROM WAHLKREISKANDIDATPOSITIONEN P JOIN     WAHLKREISZWEITSTIMMENGEWINNERZAHL Z ON ((P.WAHLKREIS=Z.WAHLKREIS) AND (P.PARTEI=Z.PARTEI))
    WHERE P.POSITION <= Z.ZWEITSTIMMENGEWINNERZAHL)
8. Welche Kandidaten ziehen in den Landtag ein?
(SELECT GEWINNER
FROM STIMMKREISGEWINNER)
UNION ALL
(SELECT KANDIDAT
FROM ZWEITSTIMMENGEWINNER)