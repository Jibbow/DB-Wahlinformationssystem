DECLARE JAHR_AKTUELL INTEGER := 2013;
DECLARE STIMMKREIS_AKTUELL INTEGER := 1;

WITH WAHLKREISSTIMMEN_HELP AS (
SELECT W.NR AS WAHLKREIS, W.SITZZAHL AS SITZZAHL, S.NR AS STIMMKREIS, AK.KANDIDATNR AS KANDIDAT, AK.ANZAHLERSTSTIMMEN AS ERSTSTIMMEN, K.PARTEI AS PARTEI, AP.ANZAHLGESAMTZWEITSTIMMEN AS ZWEITSTIMMEN
FROM (((WAHLKREIS W JOIN STIMMKREIS S ON ((W.JAHR = S.JAHR) AND (W.NR = S.WAHLKREISNR))) JOIN AGGREGATKANDIDATERSTSTIMMEN AK ON ((AK.JAHR = S.JAHR) AND (AK.STIMMKREISNR = S.NR))) JOIN KANDIDAT K ON (K.ID = AK.KANDIDATNR)) JOIN AGGREGATPARTEISTIMMEN AP ON ((AP.JAHR = S.JAHR) AND (AP.STIMMKREISNR = S.NR) AND (AP.PARTEIID = K.PARTEI))
WHERE JAHR = 2018),

WAHLKREISGESAMTSTIMMEN AS (
SELECT WAHLKREIS, (SUM(ZWEITSTIMMEN) + SUM(ERSTSTIMMEN)) AS GESAMTSTIMMEN
FROM  WAHLKREISGESAMTSTIMMEN_HELP
GROUP_BY WAHLKREIS),

WAHLKREISPARTEIGESAMTSTIMMEN AS (
SELECT WAHLKREIS, PARTEI, (SUM(ZWEITSTIMMEN)+SUM(ERSTSTIMMEN)) AS PARTEIGESAMTSTIMMEN
FROM WAHLKREISGESAMTSTIMMEN_HELP
GROUP_BY WAHLKREIS, PARTEI),

SPERRKLAUSELUNTERSCHREITER AS (
SELECT P.WAHLKREIS AS WAHLKREIS, P.PARTEI AS PARTEI, P.PARTEIGESAMTSTIMMEN AS PARTEIGESAMTSTIMMEN
FROM WAHLKREISGESAMTSTIMMEN W JOIN WAHLKREISPARTEIGESAMTSTIMMEN P ON W.WAHLKREIS=P.WAHLKREIS
WHERE CAST (P.PARTEIGESAMTSTIMMEN AS DECIMAL(8,2))/W.GESAMTSTIMMEN < 0.05),

PARTEIEN_NACH_KLAUSELN AS (
SELECT W.WAHLKREIS, W.PARTEI
FROM WAHLKREISPARTEIGESAMTSTIMMEN W MINUS SPERRKLAUSELUNTERSCHREITER S
),

STIMMKREISGEWINNER_HELP AS (
SELECT A.STIMMKREISNR, A.JAHR, MAX(A.ANZAHLERSTSTIMMEN) AS MAXSTIMMEN
FROM ((AGGREGATKANDIDATERSTSTIMMEN A JOIN KANDIDAT K ON ((K.JAHR = A.JAHR) AND (K.ID = A.KANDIDATNR))) JOIN PARTEI_NACH_KLAUSELN P ON (P.ID = K.PARTEI))
GROUP BY A.STIMMKREISNR),


SELECT K.PARTEI
FROM (AGGREGATKANDIDATERSTSTIMMEN A JOIN STIMMKREISGEWINNER_HELP S ON ((A.STIMMKREISNR = S.STIMMKREISNR) AND (S.MAXSTIMMEN = A.ANZAHLERSTSTIMMEN) AND (A.JAHR = S.JAHR))) JOIN KANDIDAT K ON ((K.ID = A.KANDIDATNR) AND (K.JAHR = A.JAHR))
WHERE (A.JAHR = JAHR_AKTUELL) AND (A.STIMMKREISNR = STIMMKREIS_AKTUELL)
