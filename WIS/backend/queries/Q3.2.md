DECLARE JAHR_AKTUELL INTEGER := 2013;
DECLARE STIMMKREIS_AKTUELL INTEGER := 1;

WITH WAHLKREISSTIMMEN_HELP AS (
SELECT W.JAHR AS JAHR, W.NR AS WAHLKREIS, S.NR AS STIMMKREIS, AK.KANDIDATNR AS KANDIDAT, AK.ANZAHLERSTSTIMMEN AS ERSTSTIMMEN, K.PARTEI AS PARTEI, AP.ANZAHLGESAMTZWEITSTIMMEN AS ZWEITSTIMMEN
FROM (((WAHLKREIS W JOIN STIMMKREIS S ON ((W.JAHR = S.JAHR) AND (W.NR = S.WAHLKREISNR))) JOIN AGGREGATKANDIDATERSTSTIMMEN AK ON ((AK.JAHR = S.JAHR) AND (AK.STIMMKREISNR = S.NR))) JOIN KANDIDAT K ON ((K.ID = AK.KANDIDATNR) AND (K.JAHR = AK.JAHR))) JOIN AGGREGATPARTEISTIMMEN AP ON ((AP.JAHR = S.JAHR) AND (AP.STIMMKREISNR = S.NR) AND (AP.PARTEIID = K.PARTEI))),

WAHLKREISGESAMTSTIMMEN AS (
SELECT WAHLKREIS, JAHR, (SUM(ZWEITSTIMMEN) + SUM(ERSTSTIMMEN)) AS GESAMTSTIMMEN
FROM  WAHLKREISGESAMTSTIMMEN_HELP
GROUP_BY WAHLKREIS, JAHR),

WAHLKREISPARTEIGESAMTSTIMMEN AS (
SELECT WAHLKREIS, JAHR, PARTEI, (SUM(ZWEITSTIMMEN)+SUM(ERSTSTIMMEN)) AS PARTEIGESAMTSTIMMEN
FROM WAHLKREISGESAMTSTIMMEN_HELP
GROUP_BY WAHLKREIS, JAHR, PARTEI),

SPERRKLAUSELUNTERSCHREITER AS (
SELECT P.WAHLKREIS AS WAHLKREIS, P.JAHR AS JAHR, P.PARTEI AS PARTEI, P.PARTEIGESAMTSTIMMEN AS PARTEIGESAMTSTIMMEN
FROM WAHLKREISGESAMTSTIMMEN W JOIN WAHLKREISPARTEIGESAMTSTIMMEN P ON ((W.WAHLKREIS=P.WAHLKREIS) AND (W.JAHR = P.JAHR))
WHERE (P.PARTEIGESAMTSTIMMEN * 100)/W.GESAMTSTIMMEN < 5),

PARTEIEN_NACH_KLAUSELN AS (
SELECT W.WAHLKREIS, W.JAHR, W.PARTEI
FROM WAHLKREISPARTEIGESAMTSTIMMEN W MINUS SPERRKLAUSELUNTERSCHREITER S
),

KANDIDATENSIEGERPUNKTE AS (
SELECT A.STIMMKREISNR, A.JAHR, MAX(A.ANZAHLERSTSTIMMEN) AS SIEGERPUNKTE
FROM ((AGGREGATKANDIDATERSTSTIMMEN A JOIN KANDIDAT K ON ((K.JAHR = A.JAHR) AND (K.ID = A.KANDIDATNR))) JOIN PARTEI_NACH_KLAUSELN P ON ((P.ID = K.PARTEI) AND (K.JAHR = P.JAHR)))
GROUP BY A.STIMMKREISNR, A.JAHR),

SELECT A.STIMMKREISNR AS STIMMKREIS, A.JAHR AS JAHR, A.KANDIDATNR AS SIEGER, S.SIEGERPUNKTE AS SIEGERPUNKTE
FROM AGGREGATKANDIDATERSTSTIMMEN A JOIN KANDIDATENSIEGERPUNKTE S ON ((A.STIMMKREISNR = S.STIMMKREISNR) AND (S.MAXSTIMMEN = A.ANZAHLERSTSTIMMEN) AND (A.JAHR = S.JAHR))
