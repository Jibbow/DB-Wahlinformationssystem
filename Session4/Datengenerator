CREATE PROCEDURE AGGREGATION AS
{BEGIN
	
WITH KANDIDATENPROPARTEI AS
(SELECT S.JAHR, S.NR AS STIMMKREIS, P.ID AS PARTEI, K.ID AS KANDIDAT, RAND() AS ANZAHLZWEITSTIMMEN
FROM ((STIMMKREIS S JOIN STIMMKREISLISTE L ON ((S.NR = L.STIMMKREISNR) AND (S.JAHR = L.JAHR))) JOIN KANDIDAT K ON (K.ID = L.KANDIDATID) JOIN PARTEI P ON (P.ID = K.PARTEI)),

SUMMEPROPARTEI AS
(SELECT K.JAHR, K.STIMMKREIS, K.PARTEI, COUNT(*) AS KANDIDATENANZAHL, SUM(ANZAHLZWEITSTIMMEN) AS ZWEITSTIMMENPROPARTEI
FROM KANDIDATENPROPARTEI K
GROUP BY K.JAHR, K.STIMMKREIS, K.PARTEI),

AGGREGATKANDIDATZUFALLSSTIMMEN AS
(SELECT K.JAHR, K.STIMMKREIS, K.KANDIDAT, ((K.ANZAHLZWEITSTIMMEN*A.ANZAHLGESAMTZWEITSTIMMEN)/S.ZWEITSTIMMENPROPARTEI) AS ANZAHLZWEITSTIMMEN
FROM (KANDIDATENPROPARTEI K JOIN SUMMEPROPARTEI ON ((S.JAHR = K.JAHR) AND (S.STIMMKREIS = K.STIMMKREIS) AND (S.PARTEI = K.PARTEI)))) JOIN AGGREGATPARTEISTIMMEN A ON ((A.PARTEIID = S.PARTEI)) AND (S.JAHR = A.JAHR) AND (S.STIMMKREISNR = A.STIMMKREISNR))

INSERT INTO AGGREGATKANDIDATZWEITSTIMMEN
(SELECT *
FROM AGGREGATKANDIDATZUFALLSSTIMMEN)

END}